#!/usr/bin/env bash
##   @autogenerated_warning@
##   @autogenerated_timestamp@

prefix="@prefix@"
pkgdatadir="@datarootdir@/@PACKAGE@"  # e.g. /usr/local/share/PACKAGE/

. "$pkgdatadir/util.sh"

ancestor="$1"
local="$2"
remote="$3"
marker="$4"
placeholder="$5"

#printErr "ancestor=$ancestor"
#printErr "local=$local"
#printErr "remote=$remote"
#printErr "marker=$marker"
#printErr "placeholder=$placeholder"

# get the diffs from the common ancestor to our states
ancestor2localDiff="$(diffDb "$ancestor" "$local")"
ancestor2remoteDiff="$(diffDb "$ancestor" "$remote")"

# apply each diff to its counterpart
sqlite3 "$local" "$ancestor2remoteDiff"
sqlite3 "$remote" "$ancestor2localDiff"

# diff our db's again
local2remote="$(diffDb "$local" "$remote" "--no-transaction")"
remote2local="$(diffDb "$remote" "$local" "--no-transaction")"

# get tmp files
local2remoteTmp="$(mktemp)"
remote2localTmp="$(mktemp)"

# add the contents
echo "$local2remote" > "$local2remoteTmp"
echo "$remote2local" > "$remote2localTmp"

# word diff the tmp files
gitDiff="$(git diff --no-index --word-diff=porcelain --word-diff-regex="\w+='.*?'" "$local2remoteTmp" "$remote2localTmp")"

echo "gitDiff = $gitDiff"

formatGitDiff()
{
    # diff --git a/tmp/tmp.MaeEcPpJNR b/tmp/tmp.gO3q9RXJhN
    # index 06ad0b0..21dc3f2 100644
    # --- a/tmp/tmp.MaeEcPpJNR
    # +++ b/tmp/tmp.gO3q9RXJhN
    # @@ -1,3 +1,3 @@

    awk -v prefix="-- " '{ if( /^diff/ || /^index/ || /^@@/ || /^\+\+\+/ || /^---/ ) { print prefix $0 } else print $0 }' \
        | grep -v "^~"

}

# throw a conflict warning if theres a diff still
if [ -n "$gitDiff" ]; then

    # format the diff for sql consumption
    fmtGitDiff="$(echo "$gitDiff" | formatGitDiff )"
    printErr "fmtGitDiff = $fmtGitDiff"

    # echo it to an output file for manual editing
    conflictFile="${placeholder}-.merge_file.sql"
    echo "$fmtGitDiff" > "$conflictFile"

    # exit the script
    exit 1

fi

# apply the diff
sqlite3 "$local" "$ancestor2remoteDiff"

