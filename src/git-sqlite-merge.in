#!/usr/bin/env bash
##   @autogenerated_warning@
##   @autogenerated_timestamp@

prefix="@prefix@"
pkgdatadir="@datarootdir@/@PACKAGE@"  # e.g. /usr/local/share/PACKAGE/

. "$pkgdatadir/util.sh"

ancestor="$1"
local="$2"
remote="$3"
marker="$4"
placeholder="$5"

#printErr "local=$local"
#printErr "remote=$remote"

# get the diffs from the common ancestor to our states
ancestor2localDiff="$(diffDb "$ancestor" "$local")"
ancestor2remoteDiff="$(diffDb "$ancestor" "$remote")"

# apply each diff to its counterpart
sqlite3 "$local" "$ancestor2remoteDiff"
sqlite3 "$remote" "$ancestor2localDiff"

# diff our db's again
local2remote="$(diffDb "$local" "$remote" "--no-transaction")"
remote2local="$(diffDb "$remote" "$local" "--no-transaction")"

# get tmp files
local2remoteTmp="$(mktemp)"
remote2localTmp="$(mktemp)"

# add the contents
echo "$local2remote" > "$local2remoteTmp"
echo "$remote2local" > "$remote2localTmp"

# word diff the tmp files
gitDiff="$(git diff --no-index --word-diff=porcelain --word-diff-regex="\w+='.*?'" "$local2remoteTmp" "$remote2localTmp")"

# throw a conflict warning if theres a diff still
if [ -n "$gitDiff" ]; then
    #printErr "$gitDiff"

    query="$(echo "$gitDiff" | git-sqlite-diff-parse )"
    printErr "\n\n$query"
    #sqlite3 "$local" "$query"
    #TODO update the conflicting field with markers and content
    exit 1
fi

# apply the diff
sqlite3 "$local" "$ancestor2remoteDiff"

#echo "marker='$marker'"
#echo "placeholder='$placeholder'"

